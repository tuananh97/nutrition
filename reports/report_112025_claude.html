<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o Ph√¢n T√≠ch Dinh D∆∞·ª°ng</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a5f4a;
            --primary-light: #2d8a6e;
            --bg-dark: #0a1f1a;
            --bg-card: #112b24;
            --bg-card-hover: #163930;
            --text-primary: #ecf0f1;
            --text-secondary: #95a5a6;
            --text-muted: #7f8c8d;
            --border: rgba(255,255,255,0.08);
            --gradient-1: linear-gradient(135deg, #1a5f4a 0%, #2d8a6e 100%);
            --gradient-2: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
            --gradient-3: linear-gradient(135deg, #3498db 0%, #5dade2 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 3rem 2rem;
            background: var(--bg-card);
            border-radius: 24px;
            border: 1px solid var(--border);
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: var(--gradient-1);
            border-radius: 24px 24px 0 0;
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        .patient-info {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            background: rgba(26,95,74,0.2);
            border-radius: 50px;
            border: 1px solid rgba(45,138,110,0.3);
        }

        .info-icon {
            width: 36px; height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-1);
            border-radius: 50%;
        }

        .info-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .info-value { font-weight: 600; }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .section-title::before {
            content: '';
            width: 4px; height: 32px;
            background: var(--gradient-1);
            border-radius: 2px;
        }

        .section-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px; height: 32px;
            background: var(--gradient-1);
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            margin-right: 0.5rem;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .kpi-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            position: relative;
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            background: var(--bg-card-hover);
        }

        .kpi-icon {
            width: 48px; height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            margin-bottom: 1rem;
        }

        .kpi-card.calories .kpi-icon { background: var(--gradient-2); }
        .kpi-card.protein .kpi-icon { background: var(--gradient-3); }
        .kpi-card.fat .kpi-icon { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
        .kpi-card.carbs .kpi-icon { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }

        .kpi-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .kpi-value small { font-size: 0.9rem; font-weight: 400; }
        .kpi-target { font-size: 0.85rem; color: var(--text-secondary); }

        .kpi-status {
            position: absolute;
            top: 1rem; right: 1rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .kpi-status.over { background: rgba(231,76,60,0.2); color: #e74c3c; }
        .kpi-status.under { background: rgba(241,196,15,0.2); color: #f1c40f; }
        .kpi-status.optimal { background: rgba(39,174,96,0.2); color: #27ae60; }

        .progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
        }

        .progress-fill.over { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .progress-fill.under { background: linear-gradient(90deg, #f1c40f, #f39c12); }
        .progress-fill.optimal { background: linear-gradient(90deg, #27ae60, #2ecc71); }

        .charts-section { margin-bottom: 3rem; }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .chart-grid { grid-template-columns: 1fr; }
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 2rem;
            border: 1px solid var(--border);
        }

        .chart-card.full-width { grid-column: 1 / -1; }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chart-title-icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-1);
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 320px;
        }

        .chart-wrapper.tall { height: 420px; }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .analysis-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .analysis-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .analysis-icon {
            width: 44px; height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .analysis-icon.best { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .analysis-icon.worst { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .analysis-icon.trend { background: var(--gradient-3); }

        .analysis-title { font-weight: 600; font-size: 1.1rem; }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .analysis-item:last-child { border-bottom: none; }
        .analysis-item-label { color: var(--text-secondary); }
        .analysis-item-value { font-weight: 600; }
        .analysis-item-value.positive { color: #27ae60; }
        .analysis-item-value.negative { color: #e74c3c; }
        .analysis-item-value.warning { color: #f1c40f; }

        .recommendations {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 2rem;
            border: 1px solid var(--border);
            margin-bottom: 3rem;
        }

        .recommendation-item {
            display: flex;
            gap: 1rem;
            padding: 1.25rem;
            background: rgba(26,95,74,0.1);
            border-radius: 16px;
            border: 1px solid rgba(45,138,110,0.2);
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .recommendation-item:hover {
            background: rgba(26,95,74,0.2);
            transform: translateX(8px);
        }

        .recommendation-icon {
            width: 40px; height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .recommendation-icon.priority-high { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .recommendation-icon.priority-medium { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .recommendation-icon.priority-low { background: linear-gradient(135deg, #27ae60, #2ecc71); }

        .recommendation-content h4 { font-weight: 600; margin-bottom: 0.25rem; }
        .recommendation-content p { color: var(--text-secondary); font-size: 0.9rem; }

        .stats-table { width: 100%; border-collapse: collapse; }

        .stats-table th, .stats-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .stats-table th {
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        .correlation-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: rgba(255,255,255,0.02);
            border-radius: 12px;
            margin-bottom: 0.75rem;
        }

        .correlation-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .correlation-badge.strong { background: rgba(39,174,96,0.2); color: #27ae60; }
        .correlation-badge.moderate { background: rgba(241,196,15,0.2); color: #f1c40f; }
        .correlation-badge.weak { background: rgba(231,76,60,0.2); color: #e74c3c; }

        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }

        .note-box {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 12px;
            border-left: 4px solid #3498db;
        }

        .note-box p { color: var(--text-secondary); font-size: 0.9rem; }

        .tip-box {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(39, 174, 96, 0.1);
            border-radius: 12px;
            border-left: 4px solid #27ae60;
        }

        .tip-box p { color: var(--text-secondary); font-size: 0.9rem; }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .header h1 { font-size: 2rem; }
            .patient-info { gap: 1rem; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .chart-wrapper { height: 280px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üçΩÔ∏è B√°o C√°o Ph√¢n T√≠ch Dinh D∆∞·ª°ng</h1>
            <p class="subtitle">Theo d√µi v√† ƒë√°nh gi√° ch·∫ø ƒë·ªô dinh d∆∞·ª°ng qua ·ªëng th√¥ng d·∫° d√†y PEG</p>
            <div class="patient-info">
                <div class="info-item">
                    <div class="info-icon">üë§</div>
                    <div>
                        <div class="info-label">B·ªánh nh√¢n</div>
                        <div class="info-value">Nam, 28 tu·ªïi</div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-icon">üè•</div>
                    <div>
                        <div class="info-label">Ph∆∞∆°ng th·ª©c</div>
                        <div class="info-value">Sond PEG + U·ªëng</div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-icon">üìÖ</div>
                    <div>
                        <div class="info-label">Th·ªùi gian</div>
                        <div class="info-value">01/11 - 23/11/2025</div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-icon">üç¥</div>
                    <div>
                        <div class="info-label">S·ªë b·ªØa/ng√†y</div>
                        <div class="info-value">6 b·ªØa</div>
                    </div>
                </div>
            </div>
        </header>

        <section class="charts-section">
            <h2 class="section-title"><span class="section-number">1</span>So S√°nh V·ªõi M·ª•c Ti√™u Dinh D∆∞·ª°ng</h2>
            <div class="kpi-grid" id="kpiGrid"></div>
        </section>

        <section class="charts-section">
            <h2 class="section-title"><span class="section-number">2</span>ƒê√°nh Gi√° ƒê·ªô C√¢n ƒê·ªëi Dinh D∆∞·ª°ng</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <h3 class="chart-title"><span class="chart-title-icon">üìä</span>T·ª∑ L·ªá Dinh D∆∞·ª°ng Th·ª±c T·∫ø vs M·ª•c Ti√™u</h3>
                    <div class="chart-wrapper"><canvas id="ratioChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title"><span class="chart-title-icon">ü•ß</span>Ph√¢n B·ªë NƒÉng L∆∞·ª£ng Trung B√¨nh</h3>
                    <div class="chart-wrapper"><canvas id="pieChart"></canvas></div>
                </div>
            </div>
        </section>

        <section class="charts-section">
            <h2 class="section-title"><span class="section-number">3</span>Ph√¢n T√≠ch C√°c Ng√†y M·∫°nh / Y·∫øu</h2>
            <div class="analysis-grid" id="dayAnalysis"></div>
        </section>

        <section class="charts-section">
            <h2 class="section-title"><span class="section-number">4</span>Ph√¢n T√≠ch Xu H∆∞·ªõng Theo Th·ªùi Gian</h2>
            <div class="chart-grid">
                <div class="chart-card full-width">
                    <h3 class="chart-title"><span class="chart-title-icon">üìà</span>Bi·∫øn ƒê·ªông NƒÉng L∆∞·ª£ng Theo Ng√†y</h3>
                    <div class="chart-wrapper tall"><canvas id="lineChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title"><span class="chart-title-icon">üìâ</span>So S√°nh V·ªõi M·ª•c Ti√™u H√†ng Ng√†y</h3>
                    <div class="chart-wrapper"><canvas id="barChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title"><span class="chart-title-icon">üéØ</span>ƒê·ªô L·ªách So V·ªõi M·ª•c Ti√™u (%)</h3>
                    <div class="chart-wrapper"><canvas id="deviationChart"></canvas></div>
                </div>
            </div>
        </section>

        <section class="charts-section">
            <h2 class="section-title"><span class="section-number">5</span>M·ªëi Quan H·ªá Gi·ªØa C√°c Nh√≥m Dinh D∆∞·ª°ng</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <h3 class="chart-title"><span class="chart-title-icon">üîó</span>T∆∞∆°ng Quan Ch·∫•t B√©o - Carbs</h3>
                    <div class="chart-wrapper"><canvas id="scatterChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title"><span class="chart-title-icon">üìê</span>Ph√¢n T√≠ch T∆∞∆°ng Quan</h3>
                    <div id="correlationAnalysis"></div>
                </div>
            </div>
        </section>

        <section>
            <h2 class="section-title"><span class="section-number">6</span>Chi·∫øn L∆∞·ª£c C·∫£i Thi·ªán Ch·∫ø ƒê·ªô ƒÇn</h2>
            <div class="recommendations" id="recommendations"></div>
        </section>

        <section>
            <h2 class="section-title"><span class="section-number">7</span>T·ªëi ∆Øu H√≥a & K·∫øt Lu·∫≠n</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <h3 class="chart-title"><span class="chart-title-icon">üìã</span>Th·ªëng K√™ T·ªïng H·ª£p</h3>
                    <table class="stats-table" id="summaryTable"></table>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title"><span class="chart-title-icon">‚ö°</span>ƒê·ªÅ Xu·∫•t ƒêi·ªÅu Ch·ªânh B·ªØa ƒÇn</h3>
                    <div id="mealAdjustments"></div>
                </div>
            </div>
        </section>

        <footer class="footer">
            <p>B√°o c√°o ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông ‚Ä¢ D·ªØ li·ªáu t·ª´ 01/11/2025 - 23/11/2025</p>
            <p>¬© 2025 H·ªá Th·ªëng Theo D√µi Dinh D∆∞·ª°ng</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // DATA
        const rawData = [
            { date: '01/11', fat: 733.78, carbs: 754.69, protein: 358.44 },
            { date: '02/11', fat: 689.99, carbs: 708.17, protein: 351.59 },
            { date: '03/11', fat: 710.93, carbs: 766.68, protein: 342.00 },
            { date: '04/11', fat: 715.15, carbs: 798.95, protein: 351.08 },
            { date: '05/11', fat: 789.05, carbs: 775.06, protein: 363.17 },
            { date: '06/11', fat: 627.38, carbs: 749.21, protein: 349.15 },
            { date: '07/11', fat: 712.34, carbs: 777.11, protein: 332.54 },
            { date: '08/11', fat: 721.66, carbs: 780.10, protein: 395.54 },
            { date: '09/11', fat: 792.56, carbs: 775.47, protein: 369.78 },
            { date: '10/11', fat: 736.22, carbs: 772.81, protein: 399.39 },
            { date: '11/11', fat: 727.46, carbs: 802.57, protein: 366.58 },
            { date: '12/11', fat: 733.34, carbs: 809.80, protein: 381.00 },
            { date: '13/11', fat: 728.80, carbs: 803.34, protein: 382.16 },
            { date: '14/11', fat: 740.11, carbs: 823.38, protein: 392.21 },
            { date: '15/11', fat: 728.30, carbs: 789.89, protein: 380.85 },
            { date: '16/11', fat: 735.46, carbs: 752.22, protein: 397.14 },
            { date: '17/11', fat: 665.80, carbs: 742.93, protein: 380.79 },
            { date: '18/11', fat: 701.57, carbs: 823.75, protein: 392.82 },
            { date: '19/11', fat: 657.49, carbs: 777.82, protein: 379.48 },
            { date: '20/11', fat: 700.55, carbs: 782.85, protein: 383.91 },
            { date: '21/11', fat: 752.32, carbs: 781.64, protein: 399.73 },
            { date: '22/11', fat: 814.58, carbs: 783.87, protein: 397.99 },
            { date: '23/11', fat: 753.84, carbs: 821.43, protein: 388.96 }
        ];

        const targets = {
            totalCalories: 1700,
            protein: { kcal: 340, percent: 20 },
            fat: { kcal: 595, percent: 35 },
            carbs: { kcal: 765, percent: 45 }
        };

        // Calculate stats
        let avgFat = 0, avgCarbs = 0, avgProtein = 0, avgTotal = 0;
        let minTotal = Infinity, maxTotal = -Infinity, worstDay = '', bestDay = '';
        const dailyTotals = [];

        rawData.forEach(d => {
            const total = d.fat + d.carbs + d.protein;
            avgFat += d.fat;
            avgCarbs += d.carbs;
            avgProtein += d.protein;
            avgTotal += total;
            dailyTotals.push({ ...d, total });
            if (total < minTotal) { minTotal = total; worstDay = d.date; }
            if (total > maxTotal) { maxTotal = total; bestDay = d.date; }
        });

        const n = rawData.length;
        avgFat /= n; avgCarbs /= n; avgProtein /= n; avgTotal /= n;

        const fatPercent = (avgFat / avgTotal) * 100;
        const carbsPercent = (avgCarbs / avgTotal) * 100;
        const proteinPercent = (avgProtein / avgTotal) * 100;

        let sumSq = 0;
        dailyTotals.forEach(d => sumSq += Math.pow(d.total - avgTotal, 2));
        const stdDev = Math.sqrt(sumSq / n);

        function calcCorr(x, y) {
            const sx = x.reduce((a,b)=>a+b,0), sy = y.reduce((a,b)=>a+b,0);
            const sxy = x.reduce((t,xi,i)=>t+xi*y[i],0);
            const sx2 = x.reduce((a,b)=>a+b*b,0), sy2 = y.reduce((a,b)=>a+b*b,0);
            const num = n*sxy - sx*sy;
            const den = Math.sqrt((n*sx2-sx*sx)*(n*sy2-sy*sy));
            return den === 0 ? 0 : num/den;
        }

        const fatCarbsCorr = calcCorr(rawData.map(d=>d.fat), rawData.map(d=>d.carbs));
        const fatProtCorr = calcCorr(rawData.map(d=>d.fat), rawData.map(d=>d.protein));
        const carbsProtCorr = calcCorr(rawData.map(d=>d.carbs), rawData.map(d=>d.protein));

        // KPI Cards
        const kpiGrid = document.getElementById('kpiGrid');
        const kpis = [
            { type: 'calories', icon: 'üî•', label: 'T·ªïng NƒÉng L∆∞·ª£ng TB', value: Math.round(avgTotal), unit: 'kcal', target: targets.totalCalories, targetLabel: 'M·ª•c ti√™u: 1700 kcal' },
            { type: 'protein', icon: 'ü•©', label: 'Protein TB', value: Math.round(avgProtein), unit: 'kcal', target: targets.protein.kcal, targetLabel: 'M·ª•c ti√™u: 340 kcal (20%)' },
            { type: 'fat', icon: 'ü•ë', label: 'Ch·∫•t B√©o TB', value: Math.round(avgFat), unit: 'kcal', target: targets.fat.kcal, targetLabel: 'M·ª•c ti√™u: 595 kcal (35%)' },
            { type: 'carbs', icon: 'üçö', label: 'Carbohydrate TB', value: Math.round(avgCarbs), unit: 'kcal', target: targets.carbs.kcal, targetLabel: 'M·ª•c ti√™u: 765 kcal (45%)' }
        ];

        kpis.forEach(kpi => {
            const pct = (kpi.value / kpi.target) * 100;
            let status, cls;
            if (pct > 110) { status = 'V∆∞·ª£t ' + Math.round(pct-100) + '%'; cls = 'over'; }
            else if (pct < 90) { status = 'Thi·∫øu ' + Math.round(100-pct) + '%'; cls = 'under'; }
            else { status = 'ƒê·∫°t m·ª•c ti√™u'; cls = 'optimal'; }

            kpiGrid.innerHTML += `
                <div class="kpi-card ${kpi.type}">
                    <span class="kpi-status ${cls}">${status}</span>
                    <div class="kpi-icon">${kpi.icon}</div>
                    <div class="kpi-label">${kpi.label}</div>
                    <div class="kpi-value">${kpi.value} <small>${kpi.unit}</small></div>
                    <div class="kpi-target">${kpi.targetLabel}</div>
                    <div class="progress-bar"><div class="progress-fill ${cls}" style="width:${Math.min(pct,100)}%"></div></div>
                </div>`;
        });

        // Day Analysis
        const sortedDev = [...dailyTotals].sort((a,b) => Math.abs(a.total - targets.totalCalories) - Math.abs(b.total - targets.totalCalories));
        const bestDays = sortedDev.slice(0,3);
        const worstDays = sortedDev.slice(-3).reverse();

        document.getElementById('dayAnalysis').innerHTML = `
            <div class="analysis-card">
                <div class="analysis-header"><div class="analysis-icon best">‚úì</div><div class="analysis-title">Ng√†y ƒê·∫°t M·ª•c Ti√™u T·ªët Nh·∫•t</div></div>
                <div>${bestDays.map(d=>`<div class="analysis-item"><span class="analysis-item-label">${d.date}</span><span class="analysis-item-value positive">${Math.round(d.total)} kcal</span></div>`).join('')}</div>
            </div>
            <div class="analysis-card">
                <div class="analysis-header"><div class="analysis-icon worst">‚ö†</div><div class="analysis-title">Ng√†y L·ªách Xa M·ª•c Ti√™u</div></div>
                <div>${worstDays.map(d=>`<div class="analysis-item"><span class="analysis-item-label">${d.date}</span><span class="analysis-item-value negative">${Math.round(d.total)} kcal (${d.total>targets.totalCalories?'+':''}${Math.round(d.total-targets.totalCalories)})</span></div>`).join('')}</div>
            </div>
            <div class="analysis-card">
                <div class="analysis-header"><div class="analysis-icon trend">üìä</div><div class="analysis-title">Th·ªëng K√™ Bi·∫øn ƒê·ªông</div></div>
                <div>
                    <div class="analysis-item"><span class="analysis-item-label">Trung b√¨nh</span><span class="analysis-item-value">${Math.round(avgTotal)} kcal</span></div>
                    <div class="analysis-item"><span class="analysis-item-label">ƒê·ªô l·ªách chu·∫©n</span><span class="analysis-item-value warning">¬±${Math.round(stdDev)} kcal</span></div>
                    <div class="analysis-item"><span class="analysis-item-label">Bi√™n ƒë·ªô</span><span class="analysis-item-value">${Math.round(minTotal)} - ${Math.round(maxTotal)} kcal</span></div>
                </div>
            </div>`;

        // Correlation Analysis
        function corrLevel(r) {
            const abs = Math.abs(r);
            if (abs > 0.7) return { l: 'M·∫°nh', c: 'strong' };
            if (abs > 0.4) return { l: 'Trung b√¨nh', c: 'moderate' };
            return { l: 'Y·∫øu', c: 'weak' };
        }

        const corrs = [
            { label: 'Ch·∫•t B√©o ‚Üî Carbs', val: fatCarbsCorr },
            { label: 'Ch·∫•t B√©o ‚Üî Protein', val: fatProtCorr },
            { label: 'Carbs ‚Üî Protein', val: carbsProtCorr }
        ];

        document.getElementById('correlationAnalysis').innerHTML = corrs.map(c => {
            const lv = corrLevel(c.val);
            const dir = c.val > 0 ? 'Thu·∫≠n' : 'Ngh·ªãch';
            return `<div class="correlation-item"><span>${c.label}</span><div><span class="correlation-badge ${lv.c}">${lv.l} (${dir})</span> <span style="color:#7f8c8d">r=${c.val.toFixed(3)}</span></div></div>`;
        }).join('') + `<div class="note-box"><p><strong>Ph√¢n t√≠ch:</strong> Khi tƒÉng ch·∫•t b√©o, l∆∞·ª£ng carbohydrate ${fatCarbsCorr > 0 ? 'c√≥ xu h∆∞·ªõng tƒÉng theo' : 'c√≥ xu h∆∞·ªõng gi·∫£m'} (r = ${fatCarbsCorr.toFixed(3)}). ƒêi·ªÅu n√†y cho th·∫•y ${Math.abs(fatCarbsCorr) > 0.5 ? 'm·ªëi li√™n h·ªá r√µ r√†ng' : 'kh√¥ng c√≥ m·ªëi li√™n h·ªá m·∫°nh'} gi·ªØa hai nh√≥m dinh d∆∞·ª°ng.</p></div>`;

        // Recommendations
        const recs = [];
        const fatDiff = avgFat - targets.fat.kcal;
        if (fatDiff > 50) recs.push({ p: 'high', i: 'ü•ë', t: 'Gi·∫£m L∆∞·ª£ng Ch·∫•t B√©o', d: `L∆∞·ª£ng ch·∫•t b√©o (${Math.round(avgFat)} kcal) v∆∞·ª£t m·ª•c ti√™u ${Math.round(fatDiff)} kcal (~${Math.round(fatDiff/9)}g). Gi·∫£m d·∫ßu/m·ª° trong s√∫p ho·∫∑c ch·ªçn s·ªØa √≠t b√©o.` });
        const protDiff = avgProtein - targets.protein.kcal;
        if (protDiff > 30) recs.push({ p: 'medium', i: 'ü•©', t: 'Protein Cao H∆°n M·ª•c Ti√™u', d: `Protein (${Math.round(avgProtein)} kcal) cao h∆°n ${Math.round(protDiff)} kcal. T√≠ch c·ª±c cho ph·ª•c h·ªìi c∆°, nh∆∞ng c·∫ßn theo d√µi th·∫≠n.` });
        const carbDiff = avgCarbs - targets.carbs.kcal;
        if (carbDiff > 30) recs.push({ p: 'medium', i: 'üçö', t: 'ƒêi·ªÅu Ch·ªânh Carbohydrate', d: `Carbs (${Math.round(avgCarbs)} kcal) cao h∆°n ${Math.round(carbDiff)} kcal. Gi·∫£m tinh b·ªôt ho·∫∑c ch·ªçn tr√°i c√¢y √≠t ƒë∆∞·ªùng.` });
        const totalDiff = avgTotal - targets.totalCalories;
        if (Math.abs(totalDiff) > 100) recs.push({ p: totalDiff > 0 ? 'high' : 'medium', i: 'üî•', t: totalDiff > 0 ? 'Gi·∫£m T·ªïng NƒÉng L∆∞·ª£ng' : 'TƒÉng T·ªïng NƒÉng L∆∞·ª£ng', d: `NƒÉng l∆∞·ª£ng ${totalDiff > 0 ? 'v∆∞·ª£t' : 'thi·∫øu'} ${Math.round(Math.abs(totalDiff))} kcal. ${totalDiff > 0 ? 'Gi·∫£m ph·∫ßn ƒÉn ho·∫∑c ch·ªçn th·ª±c ph·∫©m √≠t calo.' : 'TƒÉng ph·∫ßn ƒÉn ho·∫∑c th√™m th·ª±c ph·∫©m gi√†u nƒÉng l∆∞·ª£ng.'}` });
        if (stdDev > 80) recs.push({ p: 'medium', i: 'üìä', t: '·ªîn ƒê·ªãnh Ch·∫ø ƒê·ªô ƒÇn', d: `Bi·∫øn ƒë·ªông cao (¬±${Math.round(stdDev)} kcal). Duy tr√¨ b·ªØa ƒÉn ƒë·ªÅu ƒë·∫∑n h∆°n.` });
        recs.push({ p: 'low', i: '‚úÖ', t: 'ƒêi·ªÉm T√≠ch C·ª±c', d: 'Ch·∫ø ƒë·ªô 6 b·ªØa/ng√†y ph√π h·ª£p cho PEG. ƒêa d·∫°ng ngu·ªìn (s√∫p, s·ªØa, tr√°i c√¢y, sinh t·ªë) ƒë·∫£m b·∫£o vi ch·∫•t.' });

        document.getElementById('recommendations').innerHTML = recs.map(r => `
            <div class="recommendation-item">
                <div class="recommendation-icon priority-${r.p}">${r.i}</div>
                <div class="recommendation-content"><h4>${r.t}</h4><p>${r.d}</p></div>
            </div>`).join('');

        // Summary Table
        const rows = [
            ['S·ªë ng√†y theo d√µi', n + ' ng√†y', '-'],
            ['T·ªïng nƒÉng l∆∞·ª£ng TB', Math.round(avgTotal) + ' kcal', '1700 kcal'],
            ['Protein TB', Math.round(avgProtein) + ' kcal (' + proteinPercent.toFixed(1) + '%)', '340 kcal (20%)'],
            ['Ch·∫•t b√©o TB', Math.round(avgFat) + ' kcal (' + fatPercent.toFixed(1) + '%)', '595 kcal (35%)'],
            ['Carbohydrate TB', Math.round(avgCarbs) + ' kcal (' + carbsPercent.toFixed(1) + '%)', '765 kcal (45%)'],
            ['Ng√†y cao nh·∫•t', bestDay + ' (' + Math.round(maxTotal) + ' kcal)', '-'],
            ['Ng√†y th·∫•p nh·∫•t', worstDay + ' (' + Math.round(minTotal) + ' kcal)', '-'],
            ['ƒê·ªô l·ªách chu·∫©n', '¬±' + Math.round(stdDev) + ' kcal', '-']
        ];
        document.getElementById('summaryTable').innerHTML = '<thead><tr><th>Ch·ªâ S·ªë</th><th>Gi√° Tr·ªã</th><th>M·ª•c Ti√™u</th></tr></thead><tbody>' + rows.map(r => `<tr><td>${r[0]}</td><td><strong>${r[1]}</strong></td><td>${r[2]}</td></tr>`).join('') + '</tbody>';

        // Meal Adjustments
        const fatEx = Math.round((avgFat - targets.fat.kcal) / 9);
        const protEx = Math.round((avgProtein - targets.protein.kcal) / 4);
        const carbEx = Math.round((avgCarbs - targets.carbs.kcal) / 4);

        document.getElementById('mealAdjustments').innerHTML = `
            <div style="margin-bottom:1.5rem"><h4>ƒêi·ªÅu Ch·ªânh ƒê·ªÅ Xu·∫•t</h4><p style="color:var(--text-secondary);font-size:0.9rem">D·ª±a tr√™n ph√¢n t√≠ch 23 ng√†y</p></div>
            <div class="analysis-item"><span class="analysis-item-label">ü•ë Ch·∫•t b√©o</span><span class="analysis-item-value ${fatEx>0?'negative':'positive'}">${fatEx>0?'Gi·∫£m ~'+fatEx+'g/ng√†y':fatEx<-5?'TƒÉng ~'+Math.abs(fatEx)+'g/ng√†y':'ƒê·∫°t chu·∫©n ‚úì'}</span></div>
            <div class="analysis-item"><span class="analysis-item-label">ü•© Protein</span><span class="analysis-item-value ${protEx<-5?'negative':'positive'}">${protEx>5?'Cao h∆°n '+protEx+'g (OK)':protEx<-5?'Thi·∫øu ~'+Math.abs(protEx)+'g/ng√†y':'ƒê·∫°t chu·∫©n ‚úì'}</span></div>
            <div class="analysis-item"><span class="analysis-item-label">üçö Carbohydrate</span><span class="analysis-item-value ${carbEx>10?'warning':'positive'}">${carbEx>10?'Gi·∫£m ~'+carbEx+'g/ng√†y':carbEx<-10?'TƒÉng ~'+Math.abs(carbEx)+'g/ng√†y':'ƒê·∫°t chu·∫©n ‚úì'}</span></div>
            <div class="tip-box"><p><strong>üí° G·ª£i √Ω th·ª±c ƒë∆°n:</strong><br>‚Ä¢ <strong>S√∫p xay:</strong> Gi·∫£m 1 th√¨a d·∫ßu/b·ªØa ƒë·ªÉ gi·∫£m ~5g b√©o<br>‚Ä¢ <strong>S·ªØa:</strong> Ch·ªçn lo·∫°i √≠t b√©o/gi√†u protein<br>‚Ä¢ <strong>Sinh t·ªë:</strong> Th√™m 1 th√¨a b·ªôt protein whey n·∫øu thi·∫øu ƒë·∫°m</p></div>`;

        // CHARTS
        Chart.defaults.color = '#95a5a6';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.08)';

        // Ratio Bar Chart
        new Chart(document.getElementById('ratioChart'), {
            type: 'bar',
            data: {
                labels: ['Protein', 'Ch·∫•t B√©o', 'Carbs'],
                datasets: [{
                    label: 'Th·ª±c t·∫ø (%)',
                    data: [proteinPercent.toFixed(1), fatPercent.toFixed(1), carbsPercent.toFixed(1)],
                    backgroundColor: ['rgba(52,152,219,0.8)', 'rgba(155,89,182,0.8)', 'rgba(39,174,96,0.8)'],
                    borderRadius: 8
                }, {
                    label: 'M·ª•c ti√™u (%)',
                    data: [20, 35, 45],
                    backgroundColor: ['rgba(52,152,219,0.3)', 'rgba(155,89,182,0.3)', 'rgba(39,174,96,0.3)'],
                    borderColor: ['rgba(52,152,219,1)', 'rgba(155,89,182,1)', 'rgba(39,174,96,1)'],
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: { y: { beginAtZero: true, max: 50, ticks: { callback: v => v + '%' } } }
            }
        });

        // Pie Chart
        new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: {
                labels: ['Ch·∫•t B√©o', 'Carbs', 'Protein'],
                datasets: [{
                    data: [Math.round(avgFat), Math.round(avgCarbs), Math.round(avgProtein)],
                    backgroundColor: ['rgba(155,89,182,0.9)', 'rgba(39,174,96,0.9)', 'rgba(52,152,219,0.9)'],
                    borderWidth: 2,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: { legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } } }
            }
        });

        // Line Chart
        new Chart(document.getElementById('lineChart'), {
            type: 'line',
            data: {
                labels: rawData.map(d => d.date),
                datasets: [
                    { label: 'T·ªïng NƒÉng L∆∞·ª£ng', data: dailyTotals.map(d => Math.round(d.total)), borderColor: '#e67e22', backgroundColor: 'rgba(230,126,34,0.1)', fill: true, tension: 0.4, pointRadius: 4 },
                    { label: 'Ch·∫•t B√©o', data: rawData.map(d => Math.round(d.fat)), borderColor: '#9b59b6', tension: 0.4, pointRadius: 3 },
                    { label: 'Carbs', data: rawData.map(d => Math.round(d.carbs)), borderColor: '#27ae60', tension: 0.4, pointRadius: 3 },
                    { label: 'Protein', data: rawData.map(d => Math.round(d.protein)), borderColor: '#3498db', tension: 0.4, pointRadius: 3 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: { legend: { position: 'top' } },
                scales: { y: { beginAtZero: false, min: 300, ticks: { callback: v => v + ' kcal' } } }
            }
        });

        // Bar Chart
        new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: {
                labels: rawData.map(d => d.date),
                datasets: [{
                    label: 'Th·ª±c t·∫ø',
                    data: dailyTotals.map(d => Math.round(d.total)),
                    backgroundColor: dailyTotals.map(d => d.total > 1870 ? 'rgba(231,76,60,0.8)' : d.total < 1530 ? 'rgba(241,196,15,0.8)' : 'rgba(39,174,96,0.8)'),
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { min: 1500, max: 2200 }, x: { ticks: { maxRotation: 45, minRotation: 45 } } }
            }
        });

        // Deviation Chart
        const devs = dailyTotals.map(d => (((d.total - 1700) / 1700) * 100).toFixed(1));
        new Chart(document.getElementById('deviationChart'), {
            type: 'bar',
            data: {
                labels: rawData.map(d => d.date),
                datasets: [{
                    label: 'ƒê·ªô l·ªách (%)',
                    data: devs,
                    backgroundColor: devs.map(d => d > 0 ? 'rgba(231,76,60,0.8)' : 'rgba(241,196,15,0.8)'),
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { ticks: { callback: v => v + '%' } }, x: { ticks: { maxRotation: 45, minRotation: 45 } } }
            }
        });

        // Scatter Chart
        new Chart(document.getElementById('scatterChart'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Fat vs Carbs',
                    data: rawData.map(d => ({ x: d.fat, y: d.carbs })),
                    backgroundColor: 'rgba(52,152,219,0.7)',
                    borderColor: 'rgba(52,152,219,1)',
                    pointRadius: 8,
                    pointHoverRadius: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { title: { display: true, text: 'Ch·∫•t B√©o (kcal)' } },
                    y: { title: { display: true, text: 'Carbs (kcal)' } }
                }
            }
        });
    </script>
</body>
</html>
