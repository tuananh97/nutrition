<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Báo cáo Dinh dưỡng – Tháng 09/2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .kpi{font-variant-numeric:tabular-nums}
    .card{background:#fff;border-radius:1rem;box-shadow:0 10px 25px rgba(0,0,0,.06)}
  </style>
</head>
<body class="bg-gray-50">
<div class="max-w-7xl mx-auto px-4 py-8">
  <header class="mb-8">
    <h1 class="text-3xl font-bold">Báo cáo Dinh dưỡng – 09/2025</h1>
    <p class="text-gray-600 mt-2">Nam 28 tuổi • PEG + đồ lỏng • 6 bữa/ngày (3 súp xay, 2 sữa 230 kcal, 1 nước trái cây 200 ml, 1 sinh tố)</p>
    <div class="mt-3 text-sm text-gray-600 flex flex-wrap gap-2">
      <span class="inline-flex items-center rounded-full px-3 py-1 bg-gray-100">Mục tiêu năng lượng: <b class="ml-1">1,700 kcal</b></span>
      <span class="inline-flex items-center rounded-full px-3 py-1 bg-gray-100">Carb: <b class="ml-1">190 g</b> (45%)</span>
      <span class="inline-flex items-center rounded-full px-3 py-1 bg-gray-100">Béo: <b class="ml-1">65 g</b> (35%)</span>
      <span class="inline-flex items-center rounded-full px-3 py-1 bg-gray-100">Đạm: <b class="ml-1">75 g</b> (20%)</span>
      <span class="inline-flex items-center rounded-full px-3 py-1 bg-gray-100">Xơ: <b class="ml-1">25 g</b> (chưa có dữ liệu)</span>
    </div>
  </header>

  <section class="grid md:grid-cols-3 gap-6 mb-8">
    <div class="card p-6">
      <div class="text-sm text-gray-500">Trung bình/ngày</div>
      <div class="mt-2 text-3xl kpi"><span id="avgKcal">—</span> kcal</div>
      <div class="mt-2 text-gray-600">CV (dao động): <span id="cvKcal">—</span>%</div>
    </div>
    <div class="card p-6">
      <div class="text-sm text-gray-500">Tỷ lệ trung bình</div>
      <div class="grid grid-cols-3 gap-2 mt-2">
        <div><div class="text-2xl kpi" id="pctCarb">—</div><div class="text-gray-500 text-sm">Carb</div></div>
        <div><div class="text-2xl kpi" id="pctFat">—</div><div class="text-gray-500 text-sm">Béo</div></div>
        <div><div class="text-2xl kpi" id="pctPro">—</div><div class="text-gray-500 text-sm">Đạm</div></div>
      </div>
    </div>
    <div class="card p-6">
      <div class="text-sm text-gray-500">Ngày mạnh (đủ calo & macro)</div>
      <div class="mt-2 text-3xl kpi"><span id="strongDays">—</span> ngày</div>
    </div>
  </section>

  <section class="grid md:grid-cols-2 gap-6">
    <div class="card p-6">
      <h2 class="font-semibold mb-3">Calo theo ngày & đường mục tiêu (1,700)</h2>
      <canvas id="calLine"></canvas>
    </div>
    <div class="card p-6">
      <h2 class="font-semibold mb-3">Thành phần năng lượng theo ngày</h2>
      <canvas id="stackKcal"></canvas>
    </div>
  </section>

  <section class="grid md:grid-cols-2 gap-6 mt-6">
    <div class="card p-6">
      <h2 class="font-semibold mb-3">Phân bố trung bình vs. Mục tiêu (%)</h2>
      <div class="grid grid-cols-2 gap-4">
        <div><canvas id="avgPct"></canvas></div>
        <div><canvas id="targetPct"></canvas></div>
      </div>
      <p class="text-sm text-gray-600 mt-3">So sánh tỷ lệ năng lượng từ Carb/Béo/Đạm với mục tiêu 45/35/20.</p>
    </div>
    <div class="card p-6">
      <h2 class="font-semibold mb-3">Quan hệ giữa các nhóm (g)</h2>
      <canvas id="scatter"></canvas>
      <p class="text-sm text-gray-600 mt-3">Điểm: trục X = Carb (g), trục Y = Béo (g), kích cỡ = Đạm (g).</p>
    </div>
  </section>

  <section class="grid md:grid-cols-2 gap-6 mt-6">
    <div class="card p-6">
      <h2 class="font-semibold mb-3">Xu hướng theo tuần</h2>
      <canvas id="weeklyLine"></canvas>
    </div>
    <div class="card p-6">
      <h2 class="font-semibold mb-3">Ngày mạnh/yếu (lệch khỏi mục tiêu)</h2>
      <div class="text-sm text-gray-600 mb-2">Tiêu chí: Calo ±10%, Macro ±15% so với mục tiêu.</div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500">
              <th class="py-2 pr-3">Ngày</th><th class="py-2 pr-3">Ghi chú</th>
              <th class="py-2 pr-3">Calo</th><th class="py-2 pr-3">Béo (g)</th>
              <th class="py-2 pr-3">Carb (g)</th><th class="py-2 pr-3">Đạm (g)</th>
            </tr>
          </thead>
          <tbody id="weakBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="mt-6 card p-6">
    <h2 class="font-semibold mb-3">Nhận xét & Chiến lược cải thiện</h2>
    <ul class="list-disc pl-6 space-y-2 text-gray-800" id="insightsList"></ul>
  </section>

  <footer class="text-center text-xs text-gray-500 mt-10">Tạo tự động bằng ChatGPT • Tháng 09/2025</footer>
</div>

<script>
/*************** 1) DỮ LIỆU GỐC ****************/
const rows = `
DateTime,Fat_kcal,Carbs_kcal,Protein_kcal
01/09/2025,590.9,766.26,281.98
02/09/2025,507.37,747.34,283.86
03/09/2025,580.76,789.91,358.65
04/09/2025,586.8,815.5,254.58
05/09/2025,636.32,801.97,258.83
06/09/2025,537.78,815.98,359.74
07/09/2025,689.37,780.56,297.3
08/09/2025,699.3,849.76,286.99
09/09/2025,584.71,914.38,293.31
10/09/2025,742.3,828.87,398.37
11/09/2025,677.59,882.93,313.51
12/09/2025,593.24,807.71,399.78
13/09/2025,680.31,869.5,309.88
14/09/2025,569.2,851.92,296.4
15/09/2025,706.38,775.29,412.77
16/09/2025,696.82,771.76,324.85
17/09/2025,651.02,871.78,383.49
18/09/2025,698.74,741.28,319.1
19/09/2025,620.57,873.33,303.32
20/09/2025,684.07,765.05,315.13
21/09/2025,746.24,851.64,318.23
22/09/2025,744.77,792.74,309.71
23/09/2025,747.47,863.46,382.82
24/09/2025,698.77,844.62,307.83
25/09/2025,715.63,831.84,309.13
26/09/2025,706.3,790.51,379.77
27/09/2025,697.91,770.11,311.02
28/09/2025,693.36,731.37,375.3
29/09/2025,725.07,750.16,315.23
30/09/2025,707.16,735.13,381.67
`.trim();

/*************** 2) HÀM TIỆN ÍCH ****************/
const TARGET = { total:1700, fat_g:65, carb_g:190, pro_g:75, pct:{Carb:45,Fat:35,Pro:20} };

const parseCSV = txt => {
  const [header, ...lines] = txt.split(/\r?\n/);
  return lines.map(l=>{
    const [d,f,c,p]=l.split(',');
    const [dd,mm,yyyy]=d.split('/').map(Number);
    const date = new Date(yyyy, mm-1, dd);
    return {
      dateLabel: `${String(dd).padStart(2,'0')}/${String(mm).padStart(2,'0')}/${yyyy}`,
      date,
      fat_kcal:+f, carb_kcal:+c, pro_kcal:+p
    };
  });
};
const sum = a => a.reduce((s,x)=>s+x,0);
const mean = a => sum(a)/a.length;
const std = a => {
  const m=mean(a); return Math.sqrt(mean(a.map(x=>(x-m)*(x-m))));
};
const corr = (x,y) => {
  const mx=mean(x), my=mean(y);
  const num=sum(x.map((xi,i)=>(xi-mx)*(y[i]-my)));
  const den=Math.sqrt(sum(x.map(xi=>(xi-mx)**2))*sum(y.map(yi=>(yi-my)**2)));
  return den===0 ? 0 : +(num/den).toFixed(3);
};
function isoWeek(d) { // ISO week number
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = (date.getUTCDay() + 6) % 7;
  date.setUTCDate(date.getUTCDate() - dayNum + 3);
  const firstThursday = new Date(Date.UTC(date.getUTCFullYear(),0,4));
  const week = 1 + Math.round(((date - firstThursday)/86400000 - 3 + ((firstThursday.getUTCDay()+6)%7))/7);
  return `${date.getUTCFullYear()}-W${week}`;
}

/*************** 3) XỬ LÝ DỮ LIỆU ****************/
const data = parseCSV(rows).map(r=>{
  const total = r.fat_kcal + r.carb_kcal + r.pro_kcal;
  const fat_g = r.fat_kcal/9, carb_g = r.carb_kcal/4, pro_g = r.pro_kcal/4;
  return {
    ...r, total_kcal: total,
    fat_g, carb_g, pro_g,
    fat_pct: r.fat_kcal/total*100,
    carb_pct: r.carb_kcal/total*100,
    pro_pct:  r.pro_kcal/total*100,
  };
});

const dates = data.map(d=>d.dateLabel);
const total_kcal = data.map(d=>d.total_kcal);
const fat_kcal = data.map(d=>d.fat_kcal);
const carb_kcal = data.map(d=>d.carb_kcal);
const pro_kcal = data.map(d=>d.pro_kcal);
const fat_g = data.map(d=>d.fat_g);
const carb_g = data.map(d=>d.carb_g);
const pro_g = data.map(d=>d.pro_g);
const fat_pct = data.map(d=>d.fat_pct);
const carb_pct = data.map(d=>d.carb_pct);
const pro_pct = data.map(d=>d.pro_pct);

// KPI
const avg_total = mean(total_kcal);
const cv_total = std(total_kcal)/avg_total*100;
const avg_fat_g = mean(fat_g), avg_carb_g = mean(carb_g), avg_pro_g = mean(pro_g);
const avg_pct_fat = mean(fat_pct), avg_pct_carb = mean(carb_pct), avg_pct_pro = mean(pro_pct);

// Flags & strong days
const weakRows=[];
let strongCount=0;
data.forEach(d=>{
  const flags=[];
  if (d.total_kcal>TARGET.total*1.10) flags.push('Calo cao');
  else if (d.total_kcal<TARGET.total*0.90) flags.push('Calo thấp');
  if (d.fat_g>TARGET.fat_g*1.15) flags.push('Béo cao');
  else if (d.fat_g<TARGET.fat_g*0.85) flags.push('Béo thấp');
  if (d.carb_g>TARGET.carb_g*1.15) flags.push('Carb cao');
  else if (d.carb_g<TARGET.carb_g*0.85) flags.push('Carb thấp');
  if (d.pro_g>TARGET.pro_g*1.15) flags.push('Đạm cao');
  else if (d.pro_g<TARGET.pro_g*0.85) flags.push('Đạm thấp');
  if (flags.length) weakRows.push({...d, flags: flags.join(', ')});
  const strong = Math.abs(d.total_kcal-TARGET.total)<=TARGET.total*0.05
              && Math.abs(d.fat_g-TARGET.fat_g)<=TARGET.fat_g*0.10
              && Math.abs(d.carb_g-TARGET.carb_g)<=TARGET.carb_g*0.10
              && Math.abs(d.pro_g-TARGET.pro_g)<=TARGET.pro_g*0.10;
  if (strong) strongCount++;
});

// Weekly trend
const weekMap={};
data.forEach(d=>{
  const w = isoWeek(d.date);
  if(!weekMap[w]) weekMap[w]=[];
  weekMap[w].push(d.total_kcal);
});
const weekly_labels = Object.keys(weekMap);
const weekly_total = weekly_labels.map(k=> mean(weekMap[k]));

// Correlations
const corr_carb_fat = corr(carb_g, fat_g);
const corr_carb_pro = corr(carb_g, pro_g);
const corr_fat_pro  = corr(fat_g, pro_g);

/*************** 4) GẮN KPI LÊN UI ****************/
document.getElementById('avgKcal').textContent = Math.round(avg_total);
document.getElementById('cvKcal').textContent = cv_total.toFixed(1);
document.getElementById('pctCarb').textContent = avg_pct_carb.toFixed(1)+'%';
document.getElementById('pctFat').textContent  = avg_pct_fat.toFixed(1)+'%';
document.getElementById('pctPro').textContent  = avg_pct_pro.toFixed(1)+'%';
document.getElementById('strongDays').textContent = strongCount;

/*************** 5) VẼ BIỂU ĐỒ ****************/
new Chart(document.getElementById('calLine'),{
  type:'line',
  data:{labels:dates,datasets:[
    {label:'Tổng kcal',data:total_kcal,borderWidth:2,fill:false,tension:.2},
    {label:'Mục tiêu 1,700',data:dates.map(()=>1700),borderDash:[6,6],borderWidth:1,fill:false}
  ]},
  options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:false}}}
});

new Chart(document.getElementById('stackKcal'),{
  type:'bar',
  data:{labels:dates,datasets:[
    {label:'Béo (kcal)',data:fat_kcal,stack:'k'},
    {label:'Carb (kcal)',data:carb_kcal,stack:'k'},
    {label:'Đạm (kcal)',data:pro_kcal,stack:'k'},
  ]},
  options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{stacked:true},y:{stacked:true}}}
});

new Chart(document.getElementById('avgPct'),{
  type:'doughnut',
  data:{labels:['Carb %','Béo %','Đạm %'],datasets:[{data:[avg_pct_carb,avg_pct_fat,avg_pct_pro]}]},
  options:{plugins:{legend:{position:'bottom'}}}
});
new Chart(document.getElementById('targetPct'),{
  type:'doughnut',
  data:{labels:['Carb %','Béo %','Đạm %'],datasets:[{data:[45,35,20]}]},
  options:{plugins:{legend:{position:'bottom'}}}
});

const points = carb_g.map((cg,i)=>({x:cg,y:fat_g[i],r:Math.max(4,Math.min(14,pro_g[i]/2))}));
new Chart(document.getElementById('scatter'),{
  type:'bubble',
  data:{datasets:[{label:'Ngày',data:points}]},
  options:{scales:{x:{title:{display:true,text:'Carb (g)'}},y:{title:{display:true,text:'Béo (g)'}}}}
});

new Chart(document.getElementById('weeklyLine'),{
  type:'line',
  data:{labels:weekly_labels,datasets:[
    {label:'TB tuần (kcal)',data:weekly_total,borderWidth:2,fill:false,tension:.2},
    {label:'Mục tiêu 1,700',data:weekly_labels.map(()=>1700),borderDash:[6,6],borderWidth:1,fill:false}
  ]},
  options:{plugins:{legend:{position:'top'}}}
});

/*************** 6) BẢNG NGÀY YẾU ****************/
const tbody = document.getElementById('weakBody');
weakRows.forEach(r=>{
  const tr=document.createElement('tr');
  tr.innerHTML = `<td class="py-1 pr-3">${r.dateLabel}</td>
                  <td class="py-1 pr-3">${r.flags}</td>
                  <td class="py-1 pr-3">${Math.round(r.total_kcal)}</td>
                  <td class="py-1 pr-3">${r.fat_g.toFixed(1)}</td>
                  <td class="py-1 pr-3">${r.carb_g.toFixed(1)}</td>
                  <td class="py-1 pr-3">${r.pro_g.toFixed(1)}</td>`;
  tbody.appendChild(tr);
});

/*************** 7) INSIGHTS & CHIẾN LƯỢC ****************/
const insights=[];
const kcalGap = avg_total - 1700, kcalGapPct = kcalGap/1700*100;
insights.push(`Năng lượng trung bình ${Math.round(avg_total)} kcal (${kcalGapPct.toFixed(1)}% so với mục tiêu 1,700 kcal).`);
insights.push(`Trung bình/ngày: Béo ${avg_fat_g.toFixed(1)} g • Carb ${avg_carb_g.toFixed(1)} g • Đạm ${avg_pro_g.toFixed(1)} g.`);
insights.push(`Tỷ lệ trung bình: Carb ${avg_pct_carb.toFixed(1)}% • Béo ${avg_pct_fat.toFixed(1)}% • Đạm ${avg_pct_pro.toFixed(1)}% (mục tiêu 45/35/20).`);
const highDays = total_kcal.filter(k=>k>1700*1.10).length;
const lowDays  = total_kcal.filter(k=>k<1700*0.90).length;
insights.push(`Ngày calo cao (>110%): ${highDays} • Ngày calo thấp (<90%): ${lowDays}.`);
insights.push(`Tương quan (theo gram): Carb–Béo = ${corr_carb_fat}, Béo–Đạm = ${corr_fat_pro}, Carb–Đạm = ${corr_carb_pro}.`);
insights.push('Chiến lược: giảm đường tinh trong nước trái cây/sinh tố; chuẩn hoá dầu trong súp (≤1 thìa cà phê/bát); tăng whey/casein 10–20 g/lần để nâng % đạm khi cần; giữ 6 lần nạp ~280–290 kcal.');
insights.push('Bổ sung xơ hoà tan (yến mạch/chuối/psyllium 2–3 g) hướng tới 25 g/ngày; theo dõi dung nạp qua PEG.');
const ul=document.getElementById('insightsList');
insights.forEach(t=>{const li=document.createElement('li'); li.textContent=t; ul.appendChild(li);});
</script>
</body>
</html>
